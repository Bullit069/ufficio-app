<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Ufficio - Calendario & Messaggi</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <meta name="theme-color" content="#ffffff">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyBaKPm7_MiOtr5o63qWzQg2Up9XPunDMfY",
  authDomain: "app-ufficio.firebaseapp.com",
  projectId: "app-ufficio",
  storageBucket: "app-ufficio.appspot.com",
  messagingSenderId: "318495267097",
  appId: "1:318495267097:web:fb1a198e30daa177054d88"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function addEvent() {
      console.log('Aggiunta evento...');
      const day = document.getElementById("eventDay").value;
      const nome = document.getElementById("eventUser").value;
      const tipo = document.getElementById("eventType").value;
      if (day === "" || nome === "" || tipo === "") return;
      await addDoc(collection(db, "eventi"), {
        giorno: day,
        descrizione: tipo,
        nome: nome
      });
      document.getElementById("eventDay").value = "";
      document.getElementById("eventUser").value = "";
      document.getElementById("eventType").value = "";
      renderCalendar();
      renderTimeline();
    }

    let currentDate = new Date();

    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
      const dayNames = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];

      document.getElementById("monthYear").textContent = `${monthNames[month]} ${year}`;
      calendar.innerHTML = "";

      dayNames.forEach(day => {
        const header = document.createElement("div");
        header.className = "day header";
        header.textContent = day;
        calendar.appendChild(header);
      });

      const startDay = (firstDay.getDay() + 6) % 7;
      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement("div");
        empty.className = "day empty";
        calendar.appendChild(empty);
      }

      onSnapshot(collection(db, "eventi"), snapshot => {
        const events = {};
        snapshot.forEach(doc => {
          const e = doc.data();
          const date = new Date(e.giorno);
          if (date.getMonth() === month && date.getFullYear() === year) {
            const day = date.getDate();
            if (!events[day]) events[day] = [];
            events[day].push(e);
          }
        });

        for (let d = 1; d <= lastDay.getDate(); d++) {
          const cell = document.createElement("div");
          cell.className = "day";
          cell.innerHTML = `<strong>${d}</strong>`;
          if (events[d]) {
            events[d].forEach(ev => {
              const evDiv = document.createElement("div");
              evDiv.className = "event";
              evDiv.textContent = `${ev.nome}: ${ev.descrizione}`;
              cell.appendChild(evDiv);
            });
          }
          calendar.appendChild(cell);
        }
      });
    }

    function renderTimeline() {
      const timeline = document.getElementById("timeline");
      const q = query(collection(db, "eventi"), orderBy("giorno", "desc"));
      onSnapshot(q, snapshot => {
        timeline.innerHTML = "";
        snapshot.forEach(doc => {
          const e = doc.data();
          const div = document.createElement("div");
          div.className = "timeline-entry";
          div.innerHTML = `${e.giorno} - <strong>${e.nome}</strong>: ${e.descrizione} <button onclick=\"deleteEvent(\'${doc.id}\')\">❌</button>`;
          timeline.appendChild(div);
        });
      });
    }

    window.prevMonth = function () {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }

    window.nextMonth = function () {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }

    window.addEvent = addEvent;
    window.deleteEvent = async function(id) {
      if (confirm("Vuoi davvero eliminare questo evento?")) {
        await import('https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js').then(({ deleteDoc, doc }) => {
          deleteDoc(doc(db, "eventi", id));
        });
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      renderCalendar();
      renderTimeline();
    });
  </script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    section { margin-bottom: 2em; }
    input, textarea, button, select { margin-top: .5em; display: block; width: 100%; }
    #calendarContainer { text-align: center; }
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: .5em; margin-top: 1em; }
    .day { border: 1px solid #ccc; padding: .5em; min-height: 60px; border-radius: 4px; background: #f9f9f9; font-size: 0.9em; }
    .empty { background: none; border: none; }
    .header { background: #ddd; font-weight: bold; }
    .event { margin-top: .25em; padding: .2em; border-radius: 3px; font-size: 0.85em; color: #000; background: #e0e0e0; }
    #timeline { border-top: 1px solid #ccc; padding-top: 1em; }
    .timeline-entry { padding: .5em 0; border-bottom: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>App Ufficio</h1>

  <section>
    <h2>Calendario condiviso</h2>
    <input type="date" id="eventDay">
    <select id="eventUser">
      <option value="">-- Seleziona nome --</option>
      <option value="Fabrizio">Fabrizio</option>
      <option value="Paolo">Paolo</option>
      <option value="Ramona">Ramona</option>
      <option value="Martina">Martina</option>
    </select>
    <select id="eventType">
      <option value="">-- Tipo di evento --</option>
      <option value="Ferie">Ferie</option>
      <option value="Permesso">Permesso</option>
      <option value="Solo mattina">Solo mattina</option>
      <option value="Solo pomeriggio">Solo pomeriggio</option>
    </select>
    <button onclick="addEvent()">Aggiungi evento</button>

    <div id="calendarContainer">
      <h3>
        <button onclick="prevMonth()">⬅️</button>
        <span id="monthYear"></span>
        <button onclick="nextMonth()">➡️</button>
      </h3>
      <div id="calendar"></div>
    </div>
  </section>

  <section>
    <h2>Storico eventi</h2>
    <div id="timeline"></div>
  </section>
</body>
</html>
