

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App Ufficio - Calendario & Messaggi</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <meta name="theme-color" content="#ffffff" />
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBaKPm7_MiOtr5o63qWzQg2Up9XPunDMfY",
      authDomain: "app-ufficio.firebaseapp.com",
      projectId: "app-ufficio",
      storageBucket: "app-ufficio.appspot.com",
      messagingSenderId: "318495267097",
      appId: "1:318495267097:web:fb1a198e30daa177054d88"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function addEvent() {
      const day = document.getElementById("eventDay").value;
      const nome = document.getElementById("eventUser").value;
      const tipo = document.getElementById("eventType").value;
      if (!day || !nome || !tipo) return;
      await db.collection("eventi").add({
        giorno: day,
        descrizione: tipo,
        nome: nome
      });
      document.getElementById("eventDay").value = "";
      document.getElementById("eventUser").value = "";
      document.getElementById("eventType").value = "";
      renderCalendar();
      renderTimeline();
    }

    async function deleteEvent(id) {
      if (confirm("Vuoi davvero eliminare questo evento?")) {
        await db.collection("eventi").doc(id).delete();
      }
    }

    async function sendMessage() {
      const nome = document.getElementById("eventUser").value;
      const testo = document.getElementById("msgText").value;
      if (!nome || !testo.trim()) return alert("Inserisci nome e messaggio");
      await db.collection("messaggi").add({
        nome: nome,
        testo: testo,
        timestamp: new Date().toISOString()
      });
      document.getElementById("msgText").value = "";
    }

    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
      const dayNames = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];

      document.getElementById("monthYear").textContent = `${monthNames[month]} ${year}`;
      calendar.innerHTML = "";

      dayNames.forEach(day => {
        const header = document.createElement("div");
        header.className = "day header";
        header.textContent = day;
        calendar.appendChild(header);
      });

      const startDay = (firstDay.getDay() + 6) % 7;
      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement("div");
        empty.className = "day empty";
        calendar.appendChild(empty);
      }

      db.collection("eventi").get().then(snapshot => {
        const events = {};
        let count = 0;
        let newMessages = 0;
        snapshot.forEach((doc, index) => {
          if (count >= 100) return;
          count++;
          const e = doc.data();
          const date = new Date(e.giorno);
          if (date.getMonth() === month && date.getFullYear() === year) {
            const day = date.getDate();
            if (!events[day]) events[day] = [];
            events[day].push(e);
          }
        });

        for (let d = 1; d <= lastDay.getDate(); d++) {
          const cell = document.createElement("div");
          cell.className = "day";
          cell.innerHTML = `<strong>${d}</strong>`;
          if (events[d]) {
            events[d].forEach(ev => {
              const evDiv = document.createElement("div");
              evDiv.className = "event";
              evDiv.textContent = `${ev.nome}: ${ev.descrizione}`;
              cell.appendChild(evDiv);
            });
          }
          calendar.appendChild(cell);
        }
      });
    }

    function renderTimeline() {
      db.collection("eventi").orderBy("giorno", "desc").onSnapshot(snapshot => {
        const timeline = document.getElementById("timeline");
        timeline.innerHTML = "";
        let count = 0;
        let newMessages = 0;
        snapshot.forEach((doc, index) => {
          if (count >= 100) return;
          count++;
          const e = doc.data();
          const div = document.createElement("div");
          div.className = "timeline-entry";
          div.innerHTML = `${e.giorno} - <strong>${e.nome}</strong>: ${e.descrizione} <button onclick="deleteEvent('${doc.id}')">‚ùå</button>`;
          timeline.appendChild(div);
        });
        if (newMessages > 0) { playNotification(); mostraNotificaBrowser(m.testo); }
      });
    }

    
let lastMessageTime = null;

function attivaNotifiche() {
  if (Notification.permission === "granted") {
    alert("Le notifiche sono gi√† attive!");
  } else if (Notification.permission !== "denied") {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        alert("‚úÖ Notifiche attivate!");
      } else {
        alert("üö´ Notifiche bloccate dal browser.");
      }
    });
  }
}

function mostraNotificaBrowser(testo) {
  if (Notification.permission === "granted") {
    new Notification("üì© Nuovo messaggio in App Ufficio", { body: testo });
  }
}


function playNotification() {
  const audio = new Audio("https://notificationsounds.com/storage/sounds/file-sounds-1151-pristine.mp3");
  audio.play();
}

function renderMessages() {

      db.collection("messaggi").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const container = document.getElementById("msgBoard");
        container.innerHTML = "";
        let count = 0;
        let newMessages = 0;
        snapshot.forEach((doc, index) => {
          if (count >= 100) return;
          count++;
          const m = doc.data();
          const div = document.createElement("div");
          div.className = "msgEntry";
          div.innerHTML = `<strong>${m.nome}:</strong> ${m.testo}`;
          container.appendChild(div);
        if (index === 0 && lastMessageTime && new Date(m.timestamp) > new Date(lastMessageTime)) {
          newMessages++;
        }
        if (index === 0) {
          lastMessageTime = m.timestamp;
        }
        });
        if (newMessages > 0) { playNotification(); mostraNotificaBrowser(m.testo); }
      });
    }

    let currentDate = new Date();
    function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }

    window.onload = () => {
      renderCalendar();
      renderTimeline();
      renderMessages();
    };
  </script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f1f3f6;
      margin: 0;
      padding: 2em;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5em;
      color: #1a73e8;
    }
    section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      padding: 1.5em;
      margin-bottom: 2em;
    }
    input, textarea, button, select {
      margin-top: .5em;
      margin-bottom: 1em;
      display: block;
      width: 100%;
      padding: .6em;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    button {
      background-color: #1a73e8;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #0c5dc0;
    }
    #calendarContainer {
      text-align: center;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: .5em;
      margin-top: 1em;
    }
    .day {
      border: 1px solid #ccc;
      padding: .5em;
      min-height: 60px;
      border-radius: 6px;
      background: #fefefe;
      font-size: 0.9em;
    }
    .empty {
      background: none;
      border: none;
    }
    .header {
      background: #e8f0fe;
      font-weight: bold;
      border: none;
    }
    .event {
      margin-top: .25em;
      padding: .3em;
      border-radius: 4px;
      font-size: 0.85em;
      color: #fff;
      background: #1a73e8;
    }
    #timeline {
      border-top: 1px solid #ccc;
      padding-top: 1em;
    }
    .timeline-entry {
      padding: .5em 0;
      border-bottom: 1px solid #eee;
    }
    #msgBoard {
      margin-top: 1em;
      padding: 1em;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .msgEntry {
      padding: .5em 0;
      border-bottom: 1px solid #ddd;
    }
</style>
</head>
<body>
  <button onclick="attivaNotifiche()" style='position:fixed;top:1em;right:1em;padding:.5em 1em;background:#1a73e8;color:#fff;border:none;border-radius:6px;'>üîî Attiva Notifiche</button>
  <h1>App Ufficio</h1>

  <section>
    <h2>Calendario condiviso</h2>
    <input type="date" id="eventDay">
    <select id="eventUser">
      <option value="">-- Seleziona nome --</option>
      <option value="Fabrizio">Fabrizio</option>
      <option value="Paolo">Paolo</option>
      <option value="Ramona">Ramona</option>
      <option value="Martina">Martina</option>
    </select>
    <select id="eventType">
      <option value="">-- Tipo di evento --</option>
      <option value="Ferie">Ferie</option>
      <option value="Permesso">Permesso</option>
      <option value="Solo mattina">Solo mattina</option>
      <option value="Solo pomeriggio">Solo pomeriggio</option>
    </select>
    <button onclick="addEvent()">Aggiungi evento</button>

    <div id="calendarContainer">
      <h3><button onclick="prevMonth()">‚¨ÖÔ∏è</button> <span id="monthYear"></span> <button onclick="nextMonth()">‚û°Ô∏è</button></h3>
      <div id="calendar"></div>
    </div>
  </section>

  <section>
    <h2>Storico eventi</h2>
    <div id="timeline"></div>
  </section>

  <section>
    <h2>Messaggi interni</h2>
    <textarea id="msgText" placeholder="Scrivi un messaggio..."></textarea>
    <button onclick="sendMessage()">Invia messaggio</button>
    <div id="msgBoard"></div>
  </section>
</body>
</html>